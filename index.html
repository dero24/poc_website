<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Morphic Web ‚Äî AI Builder with Chat & History</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
  <style>
    html, body { 
      height: 100%; 
      overflow-x: hidden;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(122deg, #2435f7 0%, #9e7cea 85%);
      min-height: 100vh;
      background-attachment: fixed;
      color: #182042;
    }
    .container {
      max-width: 100vw;
      width: 95%;
      max-width: 700px;
      margin: 32px auto 20px;
      background: rgba(255,255,255,0.90);
      border-radius: 22px;
      box-shadow: 0 12px 36px 0 rgba(60,50,200,0.13);
      padding: 20px;
      backdrop-filter: blur(9px);
      position: relative;
      box-sizing: border-box;
    }
    
    .generated-content {
      margin-top: 12px;
      padding: 14px 10px 20px 10px;
      background: rgba(245,250,255,0.94);
      border-radius: 10px;
      min-height: 78px;
      max-width: 100%;
      overflow-x: auto;
      overflow-y: auto;
      box-sizing: border-box;
      word-wrap: break-word;
      position: relative;
    }
    
    .generated-content * {
      max-width: 100% !important;
      box-sizing: border-box !important;
    }
    
    .generated-content div,
    .generated-content #mainAPP,
    .generated-content .mainAPP {
      max-width: 100% !important;
      overflow-x: auto !important;
      word-wrap: break-word !important;
      box-sizing: border-box !important;
    }
    
    .generated-content input,
    .generated-content textarea,
    .generated-content button,
    .generated-content table {
      max-width: 100% !important;
      box-sizing: border-box !important;
    }
    
    .generated-content table {
      width: 100% !important;
      table-layout: fixed !important;
    }
    
    .header {text-align:center;margin-bottom:22px;}
    .logo {font-size:2.1em;color:#5857f8;font-weight:900; text-shadow:0 0 12px #dbeafe;}
    .slogan {font-size:1.11em;opacity:.88;color:#4f40b5;margin:11px auto 0;text-align:center;}
    .setup-card, .interaction-zone {margin-bottom:16px;}
    .api-input-group label{font-size:1.07em;font-weight:700;color:#7b64e7;display:block;margin-bottom:7px;}
    .api-input-group input{
      font-size:1.07em;padding:12px;width:95%;max-width:340px;border:2.1px solid #e3eafe;
      border-radius:11px;outline:none;margin-bottom:3px;box-sizing:border-box;
    }
    .api-input-group input:focus{border-color:#7f76ff;}
    .prompt-area{margin-bottom:12px;}
    .prompt-area label{font-size:1.07em;font-weight:700;color:#7b64e7;display:block;margin-bottom:7px;}
    #userIntent{
      font-size:1.07em;padding:12px;width:100%;box-sizing:border-box;border:2.1px solid #e3eafe;
      border-radius:11px;outline:none;min-height:92px;font-family:'Inter', sans-serif;resize:vertical;
    }
    #userIntent:focus{border-color:#7f76ff;}
    .generate-btn{
      width:100%;padding:16px;font-size:1.23em;background:linear-gradient(122deg, #7e76ff 0%, #c085ff 85%);
      color:#fff;border:none;border-radius:11px;cursor:pointer;font-weight:700;position:relative;
      box-shadow:0 5px 15px rgba(112,80,255,.28);transition:all 0.2s ease;
    }
    .generate-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(112,80,255,.4);}
    .generate-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;}
    .status-zone{margin-top:12px;font-size:1.05em;color:#6e6bb5;text-align:center;min-height:30px;}
    .status-zone.generating{color:#ff8800;font-weight:600;}
    .status-zone.complete{color:#22c55e;font-weight:600;}
    .status-zone.error{color:#ef4444;font-weight:600;}
    .download-area{margin-top:16px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
    .download-btn,.preview-btn,.code-btn{
      padding:10px 20px;border:2px solid #7e76ff;background:white;color:#7e76ff;border-radius:8px;
      cursor:pointer;font-weight:600;font-size:0.95em;transition:all 0.2s ease;
    }
    .download-btn:hover,.preview-btn:hover,.code-btn:hover{
      background:#7e76ff;color:white;transform:translateY(-2px);
    }
    .code-display{
      background:#2d2d2d;color:#f8f8f2;padding:16px;border-radius:8px;overflow-x:auto;
      margin-top:12px;font-family:'Monaco','Menlo','Ubuntu Mono',monospace;font-size:13px;
      line-height:1.6;max-height:400px;display:none;
    }
    .code-display pre{margin:0;white-space:pre-wrap;word-break:break-word;}

    /* NEW: Chat Refinement Panel */
    .chat-panel {
      position: fixed;
      bottom: 0;
      right: 20px;
      width: 400px;
      max-width: calc(100vw - 40px);
      background: white;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 24px rgba(0,0,0,0.15);
      transform: translateY(calc(100% - 50px));
      transition: transform 0.3s ease;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      max-height: 70vh;
    }
    
    .chat-panel.expanded {
      transform: translateY(0);
    }
    
    .chat-header {
      padding: 12px 16px;
      background: linear-gradient(122deg, #7e76ff 0%, #c085ff 85%);
      color: white;
      font-weight: 700;
      font-size: 1.1em;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 16px 16px 0 0;
      user-select: none;
    }
    
    .chat-toggle-icon {
      font-size: 1.2em;
      transition: transform 0.3s ease;
    }
    
    .chat-panel.expanded .chat-toggle-icon {
      transform: rotate(180deg);
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f8fafc;
    }
    
    .chat-message {
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 85%;
      font-size: 0.95em;
      line-height: 1.5;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .chat-message.user {
      background: linear-gradient(122deg, #7e76ff 0%, #c085ff 85%);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    
    .chat-message.assistant {
      background: white;
      color: #1a202c;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      border: 1px solid #e2e8f0;
    }
    
    .chat-message.system {
      background: #fef3c7;
      color: #92400e;
      align-self: center;
      font-size: 0.85em;
      border-radius: 20px;
      padding: 6px 12px;
    }
    
    .chat-input-container {
      padding: 12px;
      background: white;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 8px;
    }
    
    .chat-input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #e3eafe;
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 0.95em;
      resize: none;
      min-height: 40px;
      max-height: 100px;
      outline: none;
    }
    
    .chat-input:focus {
      border-color: #7f76ff;
    }
    
    .chat-send {
      padding: 10px 18px;
      background: linear-gradient(122deg, #7e76ff 0%, #c085ff 85%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      font-size: 0.95em;
    }
    
    .chat-send:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(112,80,255,.4);
    }
    
    .chat-send:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* NEW: Version History Panel */
    .history-panel {
      margin-top: 20px;
      background: rgba(245,250,255,0.94);
      border-radius: 12px;
      padding: 16px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .history-title {
      font-size: 1.2em;
      font-weight: 700;
      color: #7b64e7;
    }
    
    .history-clear {
      padding: 6px 12px;
      background: rgba(239,68,68,0.1);
      color: #ef4444;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .history-clear:hover {
      background: rgba(239,68,68,0.2);
    }
    
    .history-item {
      background: white;
      border: 2px solid #e3eafe;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .history-item:hover {
      border-color: #7e76ff;
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(112,80,255,0.2);
    }
    
    .history-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 6px;
    }
    
    .history-item-prompt {
      font-weight: 600;
      color: #1a202c;
      font-size: 0.95em;
      flex: 1;
      word-wrap: break-word;
      padding-right: 8px;
    }
    
    .history-item-time {
      font-size: 0.8em;
      color: #94a3b8;
      white-space: nowrap;
    }
    
    .history-item-preview {
      font-size: 0.85em;
      color: #64748b;
      margin-bottom: 8px;
      max-height: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .history-item-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }
    
    .history-action-btn {
      padding: 4px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.8em;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .history-load-btn {
      background: rgba(102,126,234,0.1);
      color: #667eea;
    }
    
    .history-load-btn:hover {
      background: rgba(102,126,234,0.2);
    }
    
    .history-delete-btn {
      background: rgba(239,68,68,0.1);
      color: #ef4444;
    }
    
    .history-delete-btn:hover {
      background: rgba(239,68,68,0.2);
    }
    
    .history-version-badge {
      display: inline-block;
      background: linear-gradient(122deg, #7e76ff 0%, #c085ff 85%);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: 700;
      margin-left: 6px;
    }
    
    .history-empty {
      text-align: center;
      color: #94a3b8;
      padding: 40px 20px;
      font-size: 0.95em;
    }

    /* Spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Chat Button in Main Area */
    .chat-toggle-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: linear-gradient(122deg, #7e76ff 0%, #c085ff 85%);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5em;
      box-shadow: 0 4px 16px rgba(112,80,255,0.4);
      z-index: 999;
      transition: all 0.2s ease;
      display: none;
    }
    
    .chat-toggle-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(112,80,255,0.5);
    }
    
    .chat-toggle-btn.visible {
      display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .chat-panel {
        right: 10px;
        width: calc(100vw - 20px);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">‚ú® Morphic Web</div>
      <div class="slogan">AI-Powered Website Builder with Iterative Refinement</div>
    </div>

    <div class="setup-card">
      <div class="api-input-group">
        <label for="apiKey">Groq API Key</label>
        <input type="password" id="apiKey" placeholder="gsk_..." value="">
      </div>
    </div>

    <div class="interaction-zone">
      <div class="prompt-area">
        <label for="userIntent">What would you like to build?</label>
        <textarea id="userIntent" placeholder="e.g., A modern portfolio website with dark theme and smooth animations"></textarea>
      </div>
      <button class="generate-btn" id="generateBtn" onclick="generateInterface()">
        <span id="generateBtnText">Generate Website</span>
      </button>
      <div class="status-zone" id="statusZone"></div>
    </div>

    <div class="generated-content" id="resultContainer"></div>

    <div class="download-area" id="downloadArea" style="display:none;">
      <button class="download-btn" onclick="downloadHTML()">‚¨áÔ∏è Download HTML</button>
      <button class="preview-btn" onclick="openInNewTab()">üîó Open in New Tab</button>
      <button class="code-btn" onclick="toggleCode()">üìù View Code</button>
    </div>

    <div class="code-display" id="codeDisplay">
      <pre><code id="codeContent"></code></pre>
    </div>

    <!-- Version History Panel -->
    <div class="history-panel">
      <div class="history-header">
        <div class="history-title">üìö Version History</div>
        <button class="history-clear" onclick="clearHistory()">Clear All</button>
      </div>
      <div id="historyList"></div>
    </div>
  </div>

  <!-- Chat Refinement Panel -->
  <div class="chat-panel" id="chatPanel">
    <div class="chat-header" onclick="toggleChatPanel()">
      <span>üí¨ Refine Your Website</span>
      <span class="chat-toggle-icon">‚ñº</span>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-message system">Ask me to make changes to your website! Try: "make it darker", "add a contact form", "use blue colors"</div>
    </div>
    <div class="chat-input-container">
      <textarea class="chat-input" id="chatInput" placeholder="Describe the changes you want..."></textarea>
      <button class="chat-send" id="chatSendBtn" onclick="sendChatMessage()">Send</button>
    </div>
  </div>

  <!-- Floating Chat Button (shows when chat is closed) -->
  <button class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleChatPanel()">üí¨</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>

  <script>
    // State Management
    let currentGeneratedHTML = '';
    let versionHistory = [];
    let chatConversation = [];
    let currentVersionId = null;

    // Load history on startup
    loadVersionHistory();

    // Initialize chat input enter key handler
    document.getElementById('chatInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    });

    // ===== MAIN GENERATION FUNCTION =====
    async function generateInterface() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const userIntent = document.getElementById('userIntent').value.trim();
      
      if (!apiKey) {
        alert('‚ö†Ô∏è Please enter your Groq API key');
        return;
      }
      if (!userIntent) {
        alert('‚ö†Ô∏è Please describe what you want to build');
        return;
      }

      const statusZone = document.getElementById('statusZone');
      const generateBtn = document.getElementById('generateBtn');
      const generateBtnText = document.getElementById('generateBtnText');
      const resultContainer = document.getElementById('resultContainer');

      generateBtn.disabled = true;
      generateBtnText.innerHTML = '<span class="spinner"></span> Generating...';
      statusZone.className = 'status-zone generating';
      statusZone.textContent = 'üöÄ Creating your website...';
      resultContainer.innerHTML = '';

      try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'llama-3.1-70b-versatile',
            messages: [
              {
                role: 'system',
                content: 'You are an expert web developer. Create a complete, self-contained HTML file with embedded CSS and JavaScript. Make it modern, responsive, and visually stunning. Return ONLY the HTML code, no explanations.'
              },
              {
                role: 'user',
                content: userIntent
              }
            ],
            temperature: 0.8,
            max_tokens: 8000,
            stream: true
          })
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let accumulated = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('
').filter(line => line.trim() !== '');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') break;

              try {
                const parsed = JSON.parse(data);
                const content = parsed.choices[0]?.delta?.content || '';
                accumulated += content;
              } catch (e) {
                // Ignore parse errors
              }
            }
          }
        }

        const finalHTML = extractHTMLFromResponse(accumulated);
        
        if (finalHTML) {
          currentGeneratedHTML = finalHTML;
          parseAndInjectHTML(finalHTML, resultContainer);
          
          // Save to version history
          saveToHistory(userIntent, finalHTML);
          
          // Reset chat conversation for new generation
          chatConversation = [];
          
          // Show success
          statusZone.className = 'status-zone complete';
          statusZone.textContent = '‚úÖ Website generated successfully!';
          document.getElementById('downloadArea').style.display = 'flex';
          
          // Show chat panel hint
          addChatSystemMessage('Website generated! You can now ask me to make changes.');
        } else {
          throw new Error('No valid HTML generated');
        }

      } catch (error) {
        statusZone.className = 'status-zone error';
        statusZone.textContent = '‚ùå Error: ' + error.message;
        console.error('Generation error:', error);
      }

      generateBtn.disabled = false;
      generateBtnText.textContent = 'Generate Website';
    }

    // ===== CHAT REFINEMENT FUNCTION =====
    async function sendChatMessage() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const chatInput = document.getElementById('chatInput');
      const userMessage = chatInput.value.trim();
      
      if (!apiKey) {
        alert('‚ö†Ô∏è Please enter your Groq API key');
        return;
      }
      
      if (!userMessage) return;
      
      if (!currentGeneratedHTML) {
        alert('‚ö†Ô∏è Please generate a website first before requesting changes');
        return;
      }

      // Add user message to chat
      addChatMessage(userMessage, 'user');
      chatInput.value = '';

      // Disable send button
      const sendBtn = document.getElementById('chatSendBtn');
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<span class="spinner"></span>';

      // Add to conversation history
      chatConversation.push({ role: 'user', content: userMessage });

      try {
        // Build messages with context
        const messages = [
          {
            role: 'system',
            content: `You are a web development assistant helping refine an existing website. Here is the current HTML code:

${currentGeneratedHTML}

The user wants to make changes. Apply their requested modifications and return ONLY the complete updated HTML code. No explanations, just the full HTML.`
          },
          ...chatConversation
        ];

        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'llama-3.1-70b-versatile',
            messages: messages,
            temperature: 0.7,
            max_tokens: 8000,
            stream: false
          })
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        const assistantResponse = data.choices[0].message.content;
        
        // Extract updated HTML
        const updatedHTML = extractHTMLFromResponse(assistantResponse);
        
        if (updatedHTML) {
          currentGeneratedHTML = updatedHTML;
          const resultContainer = document.getElementById('resultContainer');
          parseAndInjectHTML(updatedHTML, resultContainer);
          
          // Save to version history
          const originalPrompt = document.getElementById('userIntent').value.trim();
          saveToHistory(`${originalPrompt} (refined: ${userMessage})`, updatedHTML);
          
          // Add success message to chat
          addChatMessage('‚úÖ Changes applied successfully!', 'assistant');
          
          // Update conversation history
          chatConversation.push({ role: 'assistant', content: assistantResponse });
          
        } else {
          throw new Error('Could not extract valid HTML from response');
        }

      } catch (error) {
        addChatMessage('‚ùå Error: ' + error.message, 'assistant');
        console.error('Chat error:', error);
      }

      sendBtn.disabled = false;
      sendBtn.textContent = 'Send';
    }

    // ===== VERSION HISTORY FUNCTIONS =====
    function saveToHistory(prompt, html) {
      const version = {
        id: Date.now(),
        prompt: prompt,
        html: html,
        timestamp: new Date().toLocaleString(),
        preview: extractPreviewText(html)
      };
      
      versionHistory.unshift(version);
      
      // Keep only last 20 versions
      if (versionHistory.length > 20) {
        versionHistory = versionHistory.slice(0, 20);
      }
      
      // Save to localStorage
      try {
        localStorage.setItem('morphicVersionHistory', JSON.stringify(versionHistory));
      } catch (e) {
        console.warn('Could not save to localStorage:', e);
      }
      
      currentVersionId = version.id;
      renderVersionHistory();
    }

    function loadVersionHistory() {
      try {
        const saved = localStorage.getItem('morphicVersionHistory');
        if (saved) {
          versionHistory = JSON.parse(saved);
          renderVersionHistory();
        }
      } catch (e) {
        console.warn('Could not load version history:', e);
      }
    }

    function renderVersionHistory() {
      const historyList = document.getElementById('historyList');
      
      if (versionHistory.length === 0) {
        historyList.innerHTML = '<div class="history-empty">No versions saved yet. Generate a website to start!</div>';
        return;
      }
      
      historyList.innerHTML = versionHistory.map((version, index) => `
        <div class="history-item">
          <div class="history-item-header">
            <div class="history-item-prompt">
              ${escapeHtml(version.prompt)}
              ${version.id === currentVersionId ? '<span class="history-version-badge">Current</span>' : ''}
            </div>
            <div class="history-item-time">${version.timestamp}</div>
          </div>
          <div class="history-item-preview">${escapeHtml(version.preview)}</div>
          <div class="history-item-actions">
            <button class="history-action-btn history-load-btn" onclick="loadVersion(${version.id})">Load</button>
            <button class="history-action-btn history-delete-btn" onclick="deleteVersion(${version.id}, event)">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function loadVersion(versionId) {
      const version = versionHistory.find(v => v.id === versionId);
      if (!version) return;
      
      currentGeneratedHTML = version.html;
      currentVersionId = versionId;
      
      const resultContainer = document.getElementById('resultContainer');
      parseAndInjectHTML(version.html, resultContainer);
      
      document.getElementById('userIntent').value = version.prompt;
      document.getElementById('downloadArea').style.display = 'flex';
      
      const statusZone = document.getElementById('statusZone');
      statusZone.className = 'status-zone complete';
      statusZone.textContent = '‚úÖ Version loaded from history';
      
      renderVersionHistory();
      
      addChatSystemMessage('Version loaded! You can now refine this version.');
    }

    function deleteVersion(versionId, event) {
      if (event) event.stopPropagation();
      
      if (!confirm('Delete this version?')) return;
      
      versionHistory = versionHistory.filter(v => v.id !== versionId);
      
      try {
        localStorage.setItem('morphicVersionHistory', JSON.stringify(versionHistory));
      } catch (e) {
        console.warn('Could not save to localStorage:', e);
      }
      
      renderVersionHistory();
    }

    function clearHistory() {
      if (!confirm('Clear all version history? This cannot be undone.')) return;
      
      versionHistory = [];
      try {
        localStorage.removeItem('morphicVersionHistory');
      } catch (e) {
        console.warn('Could not clear localStorage:', e);
      }
      
      renderVersionHistory();
    }

    function extractPreviewText(html) {
      const div = document.createElement('div');
      div.innerHTML = html;
      const text = div.textContent || div.innerText || '';
      return text.slice(0, 150).trim() + (text.length > 150 ? '...' : '');
    }

    // ===== CHAT UI FUNCTIONS =====
    function toggleChatPanel() {
      const chatPanel = document.getElementById('chatPanel');
      const chatToggleBtn = document.getElementById('chatToggleBtn');
      
      chatPanel.classList.toggle('expanded');
      
      if (chatPanel.classList.contains('expanded')) {
        chatToggleBtn.classList.remove('visible');
        document.getElementById('chatInput').focus();
      } else {
        if (currentGeneratedHTML) {
          chatToggleBtn.classList.add('visible');
        }
      }
    }

    function addChatMessage(message, sender) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${sender}`;
      messageDiv.textContent = message;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addChatSystemMessage(message) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message system';
      messageDiv.textContent = message;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // Auto-expand chat panel
      const chatPanel = document.getElementById('chatPanel');
      if (!chatPanel.classList.contains('expanded')) {
        chatPanel.classList.add('expanded');
        document.getElementById('chatToggleBtn').classList.remove('visible');
      }
    }

    // ===== UTILITY FUNCTIONS =====
    function extractHTMLFromResponse(text) {
      // Try to extract from code block
      const codeBlockMatch = text.match(/``````/);
      if (codeBlockMatch) {
        return codeBlockMatch[1].trim();
      }
      
      // Check if whole response is HTML
      if (text.includes('<!DOCTYPE html>') || text.includes('<html')) {
        return text.trim();
      }
      
      return null;
    }

    function parseAndInjectHTML(raw, container) {
      let html = raw, style = '', script = '';
      
      style = html.match(/<style[^>]*>([sS]*?)</style>/i)?.[1] || '';
      script = html.match(/<script[^>]*>([sS]*?)</script>/i)?.[1] || '';
      html = html.replace(/<style[^>]*>[sS]*?</style>/gi, '').replace(/<script[^>]*>[sS]*?</script>/gi, '');
      
      container.innerHTML = html;
      
      if (style) {
        const styleEl = document.createElement('style');
        styleEl.textContent = style;
        container.appendChild(styleEl);
      }
      
      if (script) {
        const scriptEl = document.createElement('script');
        scriptEl.textContent = script;
        container.appendChild(scriptEl);
      }
    }

    function downloadHTML() {
      if (!currentGeneratedHTML) {
        alert('No HTML to download');
        return;
      }
      
      const blob = new Blob([currentGeneratedHTML], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'website.html';
      a.click();
      URL.revokeObjectURL(url);
    }

    function openInNewTab() {
      if (!currentGeneratedHTML) {
        alert('No HTML to open');
        return;
      }
      
      const blob = new Blob([currentGeneratedHTML], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    }

    function toggleCode() {
      const codeDisplay = document.getElementById('codeDisplay');
      const codeContent = document.getElementById('codeContent');
      
      if (codeDisplay.style.display === 'none') {
        codeContent.textContent = currentGeneratedHTML;
        codeDisplay.style.display = 'block';
        if (typeof Prism !== 'undefined') {
          Prism.highlightElement(codeContent);
        }
      } else {
        codeDisplay.style.display = 'none';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Keyboard shortcut for generation
    document.getElementById('userIntent')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.ctrlKey) {
        generateInterface();
      }
    });
  </script>
</body>
</html>
